<!-- soplo-virtual-game.component.html -->

<div class="game-container">
  <!-- Header del juego -->
  <header class="game-header">
    <div class="header-content">
      <button class="btn-back" (click)="volverAJuegos()">
        <span class="back-icon">â†</span>
        <span>Volver</span>
      </button>
      
      <div class="game-info">
        <h1>ğŸ¤ Reto de PronunciaciÃ³n</h1>
        <p>Pronuncia correctamente las palabras que aparecen</p>
      </div>
      
      <div class="game-stats" *ngIf="faseJuego === 'jugando'">
        <div class="stat">
          <span class="stat-label">Nivel</span>
          <span class="stat-value">{{ nivelActual }}/{{ maxNiveles }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Palabras</span>
          <span class="stat-value">{{ palabrasCompletadas }}/{{ totalPalabras }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Tiempo</span>
          <span class="stat-value">{{ formatearTiempo(getTiempoRestante()) }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Puntaje</span>
          <span class="stat-value">{{ puntaje }}</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Pantalla de instrucciones -->
  <main class="game-main" *ngIf="faseJuego === 'instrucciones'">
    <div class="instructions-screen">
      <div class="instructions-card">
        <div class="instructions-header">
          <h2>ğŸ“š CÃ³mo Jugar</h2>
          <div class="difficulty-badge">PronunciaciÃ³n</div>
        </div>
        
        <div class="instructions-content">
          <div class="step">
            <div class="step-number">1</div>
            <div class="step-text">
              <strong>Permite el micrÃ³fono</strong>
              <p>Necesitamos acceso al micrÃ³fono para escuchar tu voz</p>
            </div>
          </div>
          
          <div class="step">
            <div class="step-number">2</div>
            <div class="step-text">
              <strong>Escucha el ejemplo</strong>
              <p>Presiona el botÃ³n "Escuchar" para oÃ­r cÃ³mo se pronuncia</p>
            </div>
          </div>
          
          <div class="step">
            <div class="step-number">3</div>
            <div class="step-text">
              <strong>Pronuncia la palabra</strong>
              <p>Presiona "Hablar" y di la palabra claramente</p>
            </div>
          </div>
          
          <div class="step">
            <div class="step-number">4</div>
            <div class="step-text">
              <strong>Completa todos los niveles</strong>
              <p>Cada nivel tiene palabras mÃ¡s difÃ­ciles</p>
            </div>
          </div>
        </div>
        
        <div class="tips-section">
          <h3>ğŸ’¡ Consejos</h3>
          <ul>
            <li>ğŸ§ Busca un lugar tranquilo sin ruido</li>
            <li>ğŸ¤ Habla claro y despacio</li>
            <li>ğŸ”Š Escucha el ejemplo varias veces si lo necesitas</li>
            <li>â­ Intenta pronunciar correctamente a la primera</li>
          </ul>
        </div>
        
        <button class="btn-start" (click)="saltarInstrucciones()">
          ğŸ¤ Permitir MicrÃ³fono y Jugar
        </button>
      </div>
    </div>
  </main>

  <!-- Pantalla de preparaciÃ³n -->
  <main class="game-main" *ngIf="faseJuego === 'preparando'">
    <div class="preparing-screen">
      <div class="preparing-card">
        <div class="loading-spinner">
          <div class="spinner"></div>
        </div>
        <h2>ğŸ¤ Configurando micrÃ³fono...</h2>
        <p>Por favor, permite el acceso al micrÃ³fono cuando te lo solicite el navegador.</p>
        
        <div class="microphone-test" *ngIf="permisoMicrofono">
          <h3>âœ… MicrÃ³fono conectado</h3>
          <p>Iniciando nivel {{ nivelActual }}...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Pantalla de error -->
  <main class="game-main" *ngIf="faseJuego === 'error'">
    <div class="error-screen">
      <div class="error-card">
        <div class="error-icon">âŒ</div>
        <h2>Error de MicrÃ³fono</h2>
        <p>{{ errorMicrofono }}</p>
        
        <div class="error-solutions">
          <h3>Posibles soluciones:</h3>
          <ul>
            <li>ğŸ”„ Recarga la pÃ¡gina y permite el micrÃ³fono</li>
            <li>ğŸ”§ Verifica que tu micrÃ³fono estÃ© conectado</li>
            <li>ğŸŒ Usa Chrome o Edge (navegadores compatibles)</li>
            <li>âš™ï¸ Revisa la configuraciÃ³n de permisos del navegador</li>
          </ul>
        </div>
        
        <div class="error-actions">
          <button class="btn-retry" (click)="solicitarPermisoMicrofono()">
            ğŸ”„ Reintentar
          </button>
          <button class="btn-back-error" (click)="volverAJuegos()">
            ğŸ  Volver a Juegos
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Ãrea principal del juego -->
  <main class="game-main" *ngIf="faseJuego === 'jugando'">
    <!-- InformaciÃ³n del nivel actual -->
    <div class="nivel-info">
      <div class="nivel-badge" [style.background]="getNivelActualData().color">
        <span class="nivel-icono">{{ getNivelActualData().icono }}</span>
        <div class="nivel-detalles">
          <div class="nivel-nombre">{{ getNivelActualData().nombre }}</div>
          <div class="nivel-dificultad">{{ getNivelActualData().dificultad }}</div>
        </div>
      </div>
    </div>

    <!-- Palabra actual -->
    <div class="palabra-display">
      <div class="palabra-card">
        <div class="palabra-titulo">Pronuncia esta palabra:</div>
        <div class="palabra-actual">{{ palabraActual }}</div>
        
        <div class="palabra-acciones">
          <button class="btn-escuchar" 
                  (click)="escucharEjemplo()"
                  [disabled]="escuchandoAudio || esperandoPronunciacion">
            <span class="btn-icon">ğŸ”Š</span>
            <span>{{ escuchandoAudio ? 'Escuchando...' : 'Escuchar Ejemplo' }}</span>
          </button>
          
          <button class="btn-hablar" 
                  (click)="empezarGrabacion()"
                  [disabled]="esperandoPronunciacion || escuchandoAudio"
                  [class.recording]="esperandoPronunciacion">
            <span class="btn-icon">ğŸ¤</span>
            <span>{{ esperandoPronunciacion ? 'Escuchando...' : 'Hablar Ahora' }}</span>
          </button>
        </div>
        
        <!-- Indicador de grabaciÃ³n -->
        <div class="recording-indicator" *ngIf="esperandoPronunciacion">
          <div class="pulse-circle"></div>
          <span class="recording-text">Estoy escuchando...</span>
        </div>
      </div>
    </div>

    <!-- Feedback visual -->
    <div class="feedback-container" *ngIf="mostrandoFeedback">
      <div class="feedback-message" 
           [class.correcto]="tipoFeedback === 'correcto'"
           [class.incorrecto]="tipoFeedback === 'incorrecto'"
           [class.cerca]="tipoFeedback === 'cerca'">
        <div class="feedback-icon">
          <span *ngIf="tipoFeedback === 'correcto'">âœ…</span>
          <span *ngIf="tipoFeedback === 'incorrecto'">âŒ</span>
          <span *ngIf="tipoFeedback === 'cerca'">ğŸŸ¡</span>
        </div>
        <div class="feedback-texto">{{ mensajeFeedback }}</div>
      </div>
    </div>

    <!-- Progreso del nivel -->
    <div class="level-progress">
      <div class="progress-header">
        <h3>Progreso del Nivel {{ nivelActual }}</h3>
        <div class="progress-stats">
          {{ palabrasCompletadas }}/{{ totalPalabras }} palabras completadas
        </div>
      </div>
      
      <div class="progress-bar-container">
        <div class="progress-bar" 
             [style.width.%]="getProgresoPorcentaje()">
        </div>
      </div>
    </div>

    <!-- Historial de intentos (opcional, para debug) -->
    <!-- <div class="intentos-historial" *ngIf="intentos.length > 0">
      <h4>Ãšltimos intentos:</h4>
      <div class="intento-item" *ngFor="let intento of intentos.slice(-3)">
        <span [class.correcto]="intento.correcto">
          {{ intento.palabra }} â†’ {{ intento.escuchado }}
        </span>
      </div>
    </div> -->
  </main>

  <!-- Modal de juego completado -->
  <div class="completion-modal" *ngIf="faseJuego === 'completado'">
    <div class="modal-content">
      <div class="celebration" *ngIf="nivelActual >= maxNiveles">
        <div class="celebration-emoji">ğŸ‰</div>
        <h2>Â¡Excelente pronunciaciÃ³n!</h2>
        <p>Has completado todos los niveles del reto</p>
      </div>
      
      <div class="celebration" *ngIf="nivelActual < maxNiveles">
        <div class="celebration-emoji">â°</div>
        <h2>Â¡Buen intento!</h2>
        <p>Llegaste al nivel {{ nivelActual }}. Â¡Sigue practicando!</p>
      </div>
      
      <div class="final-stats">
        <div class="stat-final">
          <span class="stat-icon">ğŸ¯</span>
          <span class="stat-text">Nivel alcanzado: {{ nivelActual }}/{{ maxNiveles }}</span>
        </div>
        <div class="stat-final">
          <span class="stat-icon">ğŸ“</span>
          <span class="stat-text">Palabras correctas: {{ getPalabrasCorrectas() }}</span>
        </div>
        <div class="stat-final">
          <span class="stat-icon">â±ï¸</span>
          <span class="stat-text">Tiempo: {{ formatearTiempo(tiempoTranscurrido) }}</span>
        </div>
        <div class="stat-final">
          <span class="stat-icon">â­</span>
          <span class="stat-text">Puntaje: {{ puntaje }}</span>
        </div>
      </div>
      
      <div class="stars-rating" *ngIf="nivelActual >= maxNiveles">
        <span *ngFor="let star of [1,2,3]; let i = index" 
              class="star"
              [class.filled]="i < getEstrellas()">
          â­
        </span>
      </div>
      
      <div class="modal-actions">
        <button class="btn-secondary" (click)="reiniciarJuego()">
          ğŸ”„ Jugar de Nuevo
        </button>
        
        <button class="btn-primary" (click)="siguienteJuego()">
          â¡ï¸ Siguiente Juego
        </button>
        
        <button class="btn-outline" (click)="volverAJuegos()">
          ğŸ  Volver a Juegos
        </button>
      </div>
    </div>
  </div>

  <!-- Overlay del modal -->
  <div class="modal-overlay" *ngIf="faseJuego === 'completado'" (click)="volverAJuegos()"></div>
</div>