<!-- soplo-virtual-game.component.html -->

<div class="game-container">
  <!-- Header del juego -->
  <header class="game-header">
    <div class="header-content">
      <button class="btn-back" (click)="volverAJuegos()">
        <span class="back-icon">‚Üê</span>
        <span>Volver</span>
      </button>
      
      <div class="game-info">
        <h1>Reto de Pronunciaci√≥n</h1>
        <p>Pronuncia correctamente las palabras que aparecen</p>
      </div>
      
      <div class="game-stats" *ngIf="faseJuego === 'jugando'">
        <div class="stat">
          <span class="stat-label">Nivel</span>
          <span class="stat-value">{{ nivelActual }}/{{ maxNiveles }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Palabras</span>
          <span class="stat-value">{{ palabrasCompletadas }}/{{ totalPalabras }}</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Pantalla de instrucciones -->
  <main class="game-main" *ngIf="faseJuego === 'instrucciones'">
    <div class="instructions-screen">
      <div class="instructions-card">
        <div class="instructions-header">
          <h2>C√≥mo Jugar</h2>
          <div class="difficulty-badge">Pronunciaci√≥n</div>
        </div>
        
        <div class="instructions-content">
          <div class="step">
            <div class="step-number">1</div>
            <div class="step-text">
              <strong>Elige tu nivel</strong>
              <p>Puedes jugar un nivel espec√≠fico o todos en orden</p>
            </div>
          </div>
          
          <div class="step">
            <div class="step-number">2</div>
            <div class="step-text">
              <strong>Escucha el ejemplo</strong>
              <p>Presiona "Escuchar" para o√≠r c√≥mo se pronuncia</p>
            </div>
          </div>
          
          <div class="step">
            <div class="step-number">3</div>
            <div class="step-text">
              <strong>Pronuncia la palabra</strong>
              <p>Presiona "Hablar" y di la palabra claramente</p>
            </div>
          </div>
          
          <div class="step">
            <div class="step-number">4</div>
            <div class="step-text">
              <strong>Completa el nivel</strong>
              <p>Pronuncia todas las palabras correctamente</p>
            </div>
          </div>
        </div>
        
        <div class="tips-section">
          <h3>Consejos</h3>
          <ul>
            <li>Busca un lugar tranquilo sin ruido</li>
            <li>Habla claro y despacio</li>
            <li>Escucha el ejemplo varias veces si lo necesitas</li>
            <li>¬°Divi√©rtete practicando!</li>
          </ul>
        </div>
        
        <button class="btn-start" (click)="saltarInstrucciones()">
          Elegir Nivel
        </button>
      </div>
    </div>
  </main>

  <!-- Pantalla de selecci√≥n de nivel -->
  <main class="game-main" *ngIf="faseJuego === 'seleccion-nivel'">
    <div class="level-selection-screen">
      <div class="selection-header">
        <h2>Selecciona un Nivel</h2>
        <p>Elige el nivel que quieres jugar o practica todos en orden</p>
      </div>

      <!-- Opci√≥n de jugar todos los niveles -->
      <div class="play-all-section">
        <button class="btn-play-all" (click)="jugarTodosLosNiveles()">
          <span class="play-all-icon">‚ñ∂</span>
          <div class="play-all-content">
            <h3>Jugar Todos los Niveles</h3>
            <p>Completa los 7 niveles en orden, desde vocales hasta trabalenguas</p>
          </div>
          <span class="arrow">‚Üí</span>
        </button>
      </div>

      <!-- Grid de niveles individuales -->
      <div class="levels-grid">
        <div class="level-card" 
             *ngFor="let nivel of niveles"
             [style.background]="nivel.color"
             (click)="seleccionarNivel(nivel.numero)">
          <div class="level-card-header">
            <span class="level-icon">{{ nivel.icono }}</span>
            <span class="level-number">Nivel {{ nivel.numero }}</span>
          </div>
          
          <h3 class="level-name">{{ nivel.nombre }}</h3>
          <p class="level-description">{{ nivel.descripcion }}</p>
          
          <div class="level-footer">
            <span class="level-difficulty" 
                  [class.facil]="nivel.dificultad === 'facil'"
                  [class.media]="nivel.dificultad === 'media'"
                  [class.dificil]="nivel.dificultad === 'dificil'">
              {{ nivel.dificultad }}
            </span>
            <span class="level-words">{{ nivel.palabras.length }} palabras</span>
          </div>
        </div>
      </div>

      <button class="btn-back-selection" (click)="volverAlDashboard()">
        Volver a Juegos
      </button>
    </div>
  </main>

  <!-- Pantalla de preparaci√≥n -->
  <main class="game-main" *ngIf="faseJuego === 'preparando'">
    <div class="preparing-screen">
      <div class="preparing-card">
        <div class="loading-spinner">
          <div class="spinner"></div>
        </div>
        <h2>Configurando micr√≥fono...</h2>
        <p>Por favor, permite el acceso al micr√≥fono cuando te lo solicite el navegador.</p>
        
        <div class="microphone-test" *ngIf="permisoMicrofono">
          <h3>Micr√≥fono conectado</h3>
          <p>Iniciando nivel {{ nivelActual }}...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Pantalla de error -->
  <main class="game-main" *ngIf="faseJuego === 'error'">
    <div class="error-screen">
      <div class="error-card">
        <div class="error-icon">‚úï</div>
        <h2>Error de Micr√≥fono</h2>
        <p>{{ errorMicrofono }}</p>
        
        <div class="error-solutions">
          <h3>Posibles soluciones:</h3>
          <ul>
            <li>Recarga la p√°gina y permite el micr√≥fono</li>
            <li>Verifica que tu micr√≥fono est√© conectado</li>
            <li>Usa Chrome o Edge (navegadores compatibles)</li>
            <li>Revisa la configuraci√≥n de permisos del navegador</li>
          </ul>
        </div>
        
        <div class="error-actions">
          <button class="btn-retry" (click)="solicitarPermisoMicrofono()">
            Reintentar
          </button>
          <button class="btn-back-error" (click)="volverAlDashboard()">
            Volver a Juegos
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- √Årea principal del juego -->
  <main class="game-main" *ngIf="faseJuego === 'jugando'">
    <!-- Informaci√≥n del nivel actual -->
    <div class="nivel-info">
      <div class="nivel-badge" [style.background]="getNivelActualData().color">
        <span class="nivel-icono">{{ getNivelActualData().icono }}</span>
        <div class="nivel-detalles">
          <div class="nivel-nombre">{{ getNivelActualData().nombre }}</div>
          <div class="nivel-dificultad">{{ getNivelActualData().dificultad }}</div>
        </div>
      </div>
    </div>

    <!-- Palabra actual -->
    <div class="palabra-display">
      <div class="palabra-card">
        <div class="palabra-titulo">Pronuncia esta palabra:</div>
        <div class="palabra-actual">{{ palabraActual }}</div>
        
        <div class="palabra-acciones">
          <button class="btn-escuchar" 
                  (click)="escucharEjemplo()"
                  [disabled]="escuchandoAudio || esperandoPronunciacion">
            <span class="btn-icon">üîä</span>
            <span>{{ escuchandoAudio ? 'Escuchando...' : 'Escuchar Ejemplo' }}</span>
          </button>
          
          <button class="btn-hablar" 
                  (click)="empezarGrabacion()"
                  [disabled]="esperandoPronunciacion || escuchandoAudio"
                  [class.recording]="esperandoPronunciacion">
            <span class="btn-icon">üé§</span>
            <span>{{ esperandoPronunciacion ? 'Escuchando...' : 'Hablar Ahora' }}</span>
          </button>
        </div>

        <!-- Bot√≥n de reseteo de emergencia (solo visible si hay problema) -->
        <div class="debug-reset" *ngIf="escuchandoAudio || esperandoPronunciacion">
          <button class="btn-reset" (click)="resetearEstadosBotones()">
            Resetear Botones
          </button>
        </div>
        
        <!-- Mostrar lo que escuch√≥ -->
        <div class="escuchado-display" *ngIf="ultimoEscuchado && !mostrandoFeedback">
          <div class="escuchado-label">Escuch√©:</div>
          <div class="escuchado-texto">"{{ ultimoEscuchado }}"</div>
          <div class="escuchado-hint">Vuelve a intentarlo pronunciando m√°s claro</div>
        </div>
        
        <!-- Indicador de grabaci√≥n -->
        <div class="recording-indicator" *ngIf="esperandoPronunciacion">
          <div class="pulse-circle"></div>
          <span class="recording-text">Estoy escuchando...</span>
        </div>
      </div>
    </div>

    <!-- Feedback visual -->
    <div class="feedback-container" *ngIf="mostrandoFeedback">
      <div class="feedback-message" 
           [class.correcto]="tipoFeedback === 'correcto'"
           [class.incorrecto]="tipoFeedback === 'incorrecto'"
           [class.cerca]="tipoFeedback === 'cerca'">
        <div class="feedback-icon">
          <span *ngIf="tipoFeedback === 'correcto'">‚úì</span>
          <span *ngIf="tipoFeedback === 'incorrecto'">‚úï</span>
          <span *ngIf="tipoFeedback === 'cerca'">~</span>
        </div>
        <div class="feedback-texto">{{ mensajeFeedback }}</div>
      </div>
    </div>

    <!-- Progreso del nivel -->
    <div class="level-progress">
      <div class="progress-header">
        <h3>Progreso del Nivel {{ nivelActual }}</h3>
        <div class="progress-stats">
          {{ palabrasCompletadas }}/{{ totalPalabras }} palabras completadas
        </div>
      </div>
      
      <div class="progress-bar-container">
        <div class="progress-bar" 
             [style.width.%]="getProgresoPorcentaje()">
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de juego completado -->
  <div class="completion-modal" *ngIf="faseJuego === 'completado'">
    <div class="modal-content">
      <div class="celebration">
        <div class="celebration-emoji">üéâ</div>
        <h2 *ngIf="modoJuego === 'todos' && nivelActual >= maxNiveles">¬°Completaste todos los niveles!</h2>
        <h2 *ngIf="modoJuego === 'individual' || nivelActual < maxNiveles">¬°Nivel completado!</h2>
        <p *ngIf="modoJuego === 'todos' && nivelActual >= maxNiveles">
          Has practicado desde vocales hasta trabalenguas. ¬°Excelente pronunciaci√≥n!
        </p>
        <p *ngIf="modoJuego === 'individual'">
          Has completado el nivel {{ nivelActual }}: {{ getNivelActualData().nombre }}
        </p>
        <p *ngIf="modoJuego === 'todos' && nivelActual < maxNiveles">
          Llegaste hasta el nivel {{ nivelActual }}. ¬°Sigue practicando!
        </p>
      </div>
      
      <div class="final-stats">
        <div class="stat-final">
          <span class="stat-icon">üéØ</span>
          <span class="stat-text">Nivel: {{ getNivelActualData().nombre }}</span>
        </div>
        <div class="stat-final">
          <span class="stat-icon">üìù</span>
          <span class="stat-text">Palabras correctas: {{ getPalabrasCorrectas() }}/{{ getTotalIntentos() }}</span>
        </div>
        <div class="stat-final">
          <span class="stat-icon">‚ú®</span>
          <span class="stat-text">¬°Excelente trabajo!</span>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn-secondary" (click)="reiniciarNivel()">
          Repetir este nivel
        </button>
        
        <button class="btn-secondary" (click)="volverASeleccionNivel()">
          Elegir otro nivel
        </button>
        
        <button class="btn-primary" (click)="siguienteJuego()">
          Siguiente Juego
        </button>
        
        <button class="btn-outline" (click)="volverAlDashboard()">
          Volver a Juegos
        </button>
      </div>
    </div>
  </div>

  <!-- Overlay del modal -->
  <div class="modal-overlay" *ngIf="faseJuego === 'completado'"></div>
</div>