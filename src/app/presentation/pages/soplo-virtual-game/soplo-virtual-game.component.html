<!-- soplo-virtual-game.component.html -->

<div class="game-container">
  <!-- Header del juego -->
  <header class="game-header">
    <div class="header-content">
      <button class="btn-back" (click)="volverAJuegos()">
        <span class="back-icon">â†</span>
        <span>Volver</span>
      </button>
      
      <div class="game-info">
        <h1>ğŸŒ¬ï¸ Soplo Virtual</h1>
        <p>Sopla fuerte para apagar todas las velas</p>
      </div>
      
      <div class="game-stats" *ngIf="faseJuego === 'jugando'">
        <div class="stat">
          <span class="stat-label">Nivel</span>
          <span class="stat-value">{{ nivelActual }}/{{ maxNiveles }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Velas</span>
          <span class="stat-value">{{ velasApagadas }}/{{ totalVelas }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Tiempo</span>
          <span class="stat-value">{{ formatearTiempo(getTiempoRestante()) }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Puntaje</span>
          <span class="stat-value">{{ puntaje }}</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Pantalla de instrucciones -->
  <main class="game-main" *ngIf="faseJuego === 'instrucciones'">
    <div class="instructions-screen">
      <div class="instructions-card">
        <div class="instructions-header">
          <h2>ğŸ•¯ï¸ CÃ³mo Jugar</h2>
          <div class="difficulty-badge">Soplo</div>
        </div>
        
        <div class="instructions-content">
          <div class="step">
            <div class="step-number">1</div>
            <div class="step-text">
              <strong>Permite el micrÃ³fono</strong>
              <p>Necesitamos acceso al micrÃ³fono para detectar tu soplo</p>
            </div>
          </div>
          
          <div class="step">
            <div class="step-number">2</div>
            <div class="step-text">
              <strong>Sopla fuerte</strong>
              <p>Sopla hacia el micrÃ³fono para apagar las velas encendidas</p>
            </div>
          </div>
          
          <div class="step">
            <div class="step-number">3</div>
            <div class="step-text">
              <strong>Apaga todas las velas</strong>
              <p>Completa cada nivel antes de que se acabe el tiempo</p>
            </div>
          </div>
        </div>
        
        <div class="tips-section">
          <h3>ğŸ’¡ Consejos</h3>
          <ul>
            <li>ğŸ”Š Ajusta el volumen de tu dispositivo</li>
            <li>ğŸ¤ Sopla directamente al micrÃ³fono</li>
            <li>ğŸ’¨ Un soplo fuerte y constante es mÃ¡s efectivo</li>
            <li>âš¡ Cada nivel tiene mÃ¡s velas que apagar</li>
          </ul>
        </div>
        
        <button class="btn-start" (click)="saltarInstrucciones()">
          ğŸ¤ Permitir MicrÃ³fono y Jugar
        </button>
      </div>
    </div>
  </main>

  <!-- Pantalla de preparaciÃ³n -->
  <main class="game-main" *ngIf="faseJuego === 'preparando'">
    <div class="preparing-screen">
      <div class="preparing-card">
        <div class="loading-spinner">
          <div class="spinner"></div>
        </div>
        <h2>ğŸ¤ Configurando micrÃ³fono...</h2>
        <p>Por favor, permite el acceso al micrÃ³fono cuando te lo solicite el navegador.</p>
        
        <div class="microphone-test" *ngIf="permisoMicrofono">
          <h3>âœ… MicrÃ³fono conectado</h3>
          <div class="sound-meter">
            <div class="sound-bar" 
                 [style.height.%]="getIntensidadSoplo()"
                 [class.active]="getIntensidadSoplo() > 20">
            </div>
          </div>
          <p>Prueba soplando para ver si funciona</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Pantalla de error -->
  <main class="game-main" *ngIf="faseJuego === 'error'">
    <div class="error-screen">
      <div class="error-card">
        <div class="error-icon">âŒ</div>
        <h2>Error de MicrÃ³fono</h2>
        <p>{{ errorMicrofono }}</p>
        
        <div class="error-solutions">
          <h3>Posibles soluciones:</h3>
          <ul>
            <li>ğŸ”„ Recarga la pÃ¡gina y permite el micrÃ³fono</li>
            <li>ğŸ”§ Verifica que tu micrÃ³fono estÃ© conectado</li>
            <li>ğŸŒ AsegÃºrate de usar un navegador compatible</li>
            <li>âš™ï¸ Revisa la configuraciÃ³n de permisos del navegador</li>
          </ul>
        </div>
        
        <div class="error-actions">
          <button class="btn-retry" (click)="solicitarPermisoMicrofono()">
            ğŸ”„ Reintentar
          </button>
          <button class="btn-back-error" (click)="volverAJuegos()">
            ğŸ  Volver a Juegos
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Ãrea principal del juego -->
  <main class="game-main" *ngIf="faseJuego === 'jugando'">
    <!-- Indicador de soplo -->
    <div class="breath-indicator">
      <div class="breath-meter">
        <div class="breath-label">Intensidad del soplo:</div>
        <div class="breath-bar-container">
          <div class="breath-bar" 
               [style.width.%]="getIntensidadSoplo()"
               [class.breathing]="getIntensidadSoplo() > 20">
          </div>
        </div>
        <div class="breath-value">{{ getIntensidadSoplo().toFixed(0) }}%</div>
      </div>
    </div>

    <!-- Ãrea de velas -->
    <div class="candles-area">
      <div *ngFor="let vela of velas" 
           class="candle-container"
           [style.left.px]="vela.x"
           [style.top.px]="vela.y">
        
        <!-- Vela encendida -->
        <div class="candle" *ngIf="!vela.apagada">
          <div class="flame" 
               [style.opacity]="vela.intensidadLlama"
               [class.flickering]="vela.intensidadLlama < 0.5">
            ğŸ”¥
          </div>
          <div class="candle-body">ğŸ•¯ï¸</div>
        </div>
        
        <!-- Vela apagada -->
        <div class="candle extinguished" *ngIf="vela.apagada">
          <div class="smoke">ğŸ’¨</div>
          <div class="candle-body">ğŸ•¯ï¸</div>
        </div>
      </div>
    </div>

    <!-- PartÃ­culas de soplo -->
    <div class="particles-container">
      <div *ngFor="let particula of particulas" 
           class="particle"
           [style.left.px]="particula.x"
           [style.top.px]="particula.y">
        ğŸ’¨
      </div>
    </div>

    <!-- Progreso del nivel -->
    <div class="level-progress">
      <div class="progress-header">
        <h3>Nivel {{ nivelActual }} - Apaga todas las velas</h3>
        <div class="progress-stats">
          {{ velasApagadas }}/{{ totalVelas }} velas apagadas
        </div>
      </div>
      
      <div class="progress-bar-container">
        <div class="progress-bar" 
             [style.width.%]="(velasApagadas / totalVelas) * 100">
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de juego completado -->
  <div class="completion-modal" *ngIf="faseJuego === 'completado'">
    <div class="modal-content">
      <div class="celebration" *ngIf="nivelActual >= maxNiveles">
        <div class="celebration-emoji">ğŸ‰</div>
        <h2>Â¡Excelente soplo!</h2>
        <p>Has apagado todas las velas en todos los niveles</p>
      </div>
      
      <div class="celebration" *ngIf="nivelActual < maxNiveles">
        <div class="celebration-emoji">â°</div>
        <h2>Â¡Buen intento!</h2>
        <p>Llegaste al nivel {{ nivelActual }}. Â¡Sigue practicando tu soplo!</p>
      </div>
      
      <div class="final-stats">
        <div class="stat-final">
          <span class="stat-icon">ğŸ¯</span>
          <span class="stat-text">Nivel alcanzado: {{ nivelActual }}/{{ maxNiveles }}</span>
        </div>
        <div class="stat-final">
          <span class="stat-icon">ğŸ•¯ï¸</span>
          <span class="stat-text">Velas apagadas: {{ velasApagadas }}</span>
        </div>
        <div class="stat-final">
          <span class="stat-icon">â±ï¸</span>
          <span class="stat-text">Tiempo: {{ formatearTiempo(tiempoTranscurrido) }}</span>
        </div>
        <div class="stat-final">
          <span class="stat-icon">â­</span>
          <span class="stat-text">Puntaje: {{ puntaje }}</span>
        </div>
      </div>
      
      <div class="stars-rating" *ngIf="nivelActual >= maxNiveles">
        <span *ngFor="let star of [1,2,3]; let i = index" 
              class="star"
              [class.filled]="i < getEstrellas()">
          â­
        </span>
      </div>
      
      <div class="modal-actions">
        <button class="btn-secondary" (click)="reiniciarJuego()">
          ğŸ”„ Jugar de Nuevo
        </button>
        
        <button class="btn-primary" (click)="siguienteJuego()">
          â¡ï¸ Siguiente Juego
        </button>
        
        <button class="btn-outline" (click)="volverAJuegos()">
          ğŸ  Volver a Juegos
        </button>
      </div>
    </div>
  </div>

  <!-- Overlay del modal -->
  <div class="modal-overlay" *ngIf="faseJuego === 'completado'" (click)="volverAJuegos()"></div>
</div>