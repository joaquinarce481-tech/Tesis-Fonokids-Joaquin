<!-- puzzle-movimientos-game.component.html -->

<div class="game-container">
  <!-- Header del juego -->
  <header class="game-header">
    <div class="header-content">
      <button class="btn-back" (click)="volverAJuegos()">
        <span class="back-icon">‚Üê</span>
        <span>Volver</span>
      </button>
      
      <div class="game-info">
        <h1>Puzzle de Movimientos</h1>
        <p>Ordena los ejercicios en la secuencia correcta</p>
      </div>
      
      <div class="game-stats" *ngIf="faseJuego !== 'instrucciones' && faseJuego !== 'captura' && faseJuego !== 'completado'">
        <div class="stat-item">
          <span class="stat-label">Nivel</span>
          <span class="stat-value">{{ nivelActual }}/{{ maxNiveles }}</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Pantalla de instrucciones -->
  <div *ngIf="faseJuego === 'instrucciones'" class="instructions-screen">
    <div class="instructions-content">
      <div class="instructions-header">
        <h2>¬øC√≥mo jugar?</h2>
      </div>
      
      <div class="instructions-list">
        <div class="instruction-item">
          <span class="instruction-number">1</span>
          <div class="instruction-text">
            <h3>T√≥mate fotos haciendo los movimientos</h3>
            <p>Primero capturaremos tus fotos haciendo cada ejercicio lingual</p>
          </div>
        </div>
        
        <div class="instruction-item">
          <span class="instruction-number">2</span>
          <div class="instruction-text">
            <h3>El sistema validar√° tu movimiento</h3>
            <p>Solo podr√°s capturar la foto cuando hagas el ejercicio correctamente</p>
          </div>
        </div>
        
        <div class="instruction-item">
          <span class="instruction-number">3</span>
          <div class="instruction-text">
            <h3>Arrastra tus fotos</h3>
            <p>Ordena tus propias fotos en la secuencia correcta</p>
          </div>
        </div>
        
        <div class="instruction-item">
          <span class="instruction-number">4</span>
          <div class="instruction-text">
            <h3>Verifica tu secuencia</h3>
            <p>Presiona el bot√≥n para comprobar si el orden es correcto</p>
          </div>
        </div>
      </div>
      
      <div class="instructions-footer">
        <button class="btn-primary" (click)="empezarNivel()">
          ¬°Tomar Fotos y Jugar!
        </button>
        <p class="difficulty-info">6 niveles de dificultad progresiva</p>
      </div>
    </div>
  </div>

  <!-- ============ FASE DE CAPTURA DE FOTOS ============ -->
  <div *ngIf="faseJuego === 'captura'" class="capture-screen">
    <div class="capture-content">
      <div class="capture-header">
        <h2>Captura de Movimientos</h2>
        <p>T√≥mate fotos haciendo cada ejercicio lingual</p>
      </div>

      <div *ngIf="todosLosMovimientos && todosLosMovimientos[movimientoActualCaptura]" class="capture-main-layout">
        <!-- COLUMNA IZQUIERDA: C√°mara y Canvas -->
        <div class="camera-container">
          <div class="video-wrapper">
            <video #videoElement autoplay playsinline class="camera-video"></video>
            <canvas #canvasElement class="camera-canvas"></canvas>
            
            <!-- Overlay de validaci√≥n -->
            <div class="validation-overlay" 
                 [class.detected]="movimientoDetectado"
                 [class.not-detected]="!movimientoDetectado">
              <div class="validation-message">
                <p>{{ mensajeValidacion }}</p>
              </div>
            </div>
          </div>

          <!-- Bot√≥n de captura -->
          <div class="capture-actions">
            <button 
              class="btn-capture"
              [disabled]="!movimientoDetectado"
              [class.ready]="movimientoDetectado"
              (click)="capturarFoto()">
              <span class="capture-icon">üì∏</span>
              <span *ngIf="movimientoDetectado">¬°Tomar Foto!</span>
              <span *ngIf="!movimientoDetectado">Haz el movimiento primero</span>
            </button>
          </div>
        </div>

        <!-- COLUMNA DERECHA: Ejercicio Actual -->
        <div class="current-movement">
          <div class="movement-info"
               [class.detected]="movimientoDetectado"
               [class.not-detected]="!movimientoDetectado">
            <div class="movement-icon">
              {{ todosLosMovimientos[movimientoActualCaptura]?.emoji }}
            </div>
            <h3>{{ todosLosMovimientos[movimientoActualCaptura]?.nombre }}</h3>
            <p class="movement-instruction">
              {{ todosLosMovimientos[movimientoActualCaptura]?.instruccion }}
            </p>
          </div>
        </div>
      </div>

      <!-- Progreso de captura -->
      <div class="capture-progress">
        <h4>Progreso de fotos:</h4>
        <div class="photos-progress">
          <div *ngFor="let mov of todosLosMovimientos; let i = index" 
               class="photo-item"
               [class.completed]="mov?.foto !== null"
               [class.current]="i === movimientoActualCaptura">
            <div class="photo-icon">
              <span *ngIf="mov?.foto === null">{{ mov?.emoji }}</span>
              <span *ngIf="mov?.foto !== null">‚úÖ</span>
            </div>
            <span class="photo-name">{{ mov?.nombre }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ PANTALLA DE JUEGO ============ -->
  <div *ngIf="faseJuego === 'jugando' || faseJuego === 'verificando'" class="game-screen">
    <!-- Informaci√≥n del nivel -->
    <div class="level-info">
      <div class="level-header">
        <h2>Nivel {{ nivelActual }}: {{ secuenciaActual?.nombre }}</h2>
        <p>{{ secuenciaActual?.descripcion }}</p>
        <div class="difficulty-badge" [ngClass]="'difficulty-' + secuenciaActual?.dificultad">
          {{ secuenciaActual?.dificultad?.toUpperCase() }}
        </div>
      </div>
      
      <div class="game-controls">
        <div class="timer-display">
          <span class="timer-icon">‚è±Ô∏è</span>
          <span class="timer-text">{{ formatearTiempo(obtenerTiempoRestante()) }}</span>
        </div>
        
        <div class="attempts-display">
          <span class="attempts-icon">üéØ</span>
          <span class="attempts-text">Intento {{ intentos + 1 }}</span>
        </div>
        
        <div class="progress-display">
          <span class="progress-icon">üìä</span>
          <span class="progress-text">{{ obtenerPorcentajeProgreso() }}%</span>
        </div>
      </div>
    </div>

    <!-- LAYOUT DE 2 COLUMNAS -->
    <div class="game-layout-columns">
      <!-- COLUMNA IZQUIERDA: Banco de fotos -->
      <div class="movements-bank movements-bank-vertical">
        <div class="photos-counter">
          {{ movimientosArrastrable?.length || 0 }} fotos disponibles
        </div>
        
        <div class="movements-vertical-list">
        <div 
          *ngFor="let movimiento of movimientosArrastrable" 
          class="movement-card movement-card-compact"
          [ngClass]="{
            'movement-placed': movimiento?.colocado,
            'movement-dragging': movimiento?.arrastrando,
            'movement-available': !movimiento?.colocado
          }"
          [draggable]="!movimiento?.colocado && faseJuego === 'jugando'"
          (dragstart)="onDragStart($event, movimiento)"
          (dragend)="onDragEnd($event, movimiento)">
          
          <div class="movement-photo movement-photo-compact" *ngIf="movimiento?.foto">
            <img [src]="movimiento.foto" alt="Foto del movimiento">
          </div>
          
          <div class="movement-emoji movement-emoji-compact" *ngIf="!movimiento?.foto && movimiento?.emoji">
            {{ movimiento.emoji }}
          </div>
          
          <div class="movement-name movement-name-compact">{{ movimiento?.nombre }}</div>
          
          <div *ngIf="movimiento?.colocado" class="placed-indicator placed-indicator-compact">
            <span class="placed-icon">‚úì</span>
          </div>
        </div>
        </div>
      </div>

      <!-- COLUMNA DERECHA: Zona de construcci√≥n -->
      <div class="sequence-column">
        <div class="sequence-builder">
          <h3>Construye la secuencia correcta:</h3>
      
      <div class="drop-zones" [style.grid-template-columns]="'repeat(' + (zonasDestino?.length || 1) + ', 1fr)'">
        <div 
          *ngFor="let zona of zonasDestino; let i = index" 
          class="drop-zone"
          [ngClass]="{
            'zone-occupied': zona !== null,
            'zone-correct': secuenciaCompleta && obtenerMovimientoPorId(zona!)?.posicionCorrecta === i,
            'zone-incorrect': faseJuego === 'verificando' && zona !== null && obtenerMovimientoPorId(zona!)?.posicionCorrecta !== i
          }"
          (dragover)="onDragOver($event)"
          (drop)="onDrop($event, i)">
          
          <div class="zone-number">{{ i + 1 }}</div>
          
          <div *ngIf="zona === null" class="zone-placeholder">
            <span class="placeholder-text">Suelta aqu√≠</span>
          </div>
          
          <div *ngIf="zona !== null" class="zone-content">
            <div class="movement-card placed" 
                 [draggable]="faseJuego === 'jugando'"
                 (dragstart)="onDragStart($event, obtenerMovimientoPorId(zona)!)">
              
              <div class="movement-photo" *ngIf="obtenerMovimientoPorId(zona)?.foto">
                <img [src]="obtenerMovimientoPorId(zona)?.foto" alt="Foto del movimiento">
              </div>
              
              <div class="movement-emoji" *ngIf="!obtenerMovimientoPorId(zona)?.foto && obtenerMovimientoPorId(zona)?.emoji">
                {{ obtenerMovimientoPorId(zona)?.emoji }}
              </div>
              
              <div class="movement-name">{{ obtenerMovimientoPorId(zona)?.nombre }}</div>
              <div class="movement-instruction">{{ obtenerMovimientoPorId(zona)?.instruccion }}</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sequence-actions">
        <button 
          class="btn-verify" 
          [disabled]="faseJuego === 'verificando' || !secuenciaCompleta"
          (click)="verificarSecuencia()">
          <span class="verify-icon">‚úì</span>
          Verificar Secuencia
        </button>
        
        <button 
          *ngIf="mostrarPista" 
          class="btn-hint"
          (click)="mostrarPista = false">
          <span class="hint-icon">üí°</span>
          Ocultar Pista
        </button>
      </div>
    </div>
    </div>

    <!-- Panel de pistas -->
    <div *ngIf="mostrarPista" class="hints-panel">
      <div class="hints-content">
        <h4>Pista para la secuencia:</h4>
        <div class="hint-text">
          <p>Los ejercicios linguales suelen seguir este orden:</p>
          <ol class="hint-list">
            <li>Preparaci√≥n y posicionamiento inicial</li>
            <li>Movimientos b√°sicos de extensi√≥n</li>
            <li>Ejercicios de coordinaci√≥n lateral</li>
            <li>Movimientos avanzados y precisos</li>
            <li>Relajaci√≥n y posici√≥n de descanso</li>
          </ol>
        </div>
        
        <button class="btn-close-hint" (click)="mostrarPista = false">
          <span class="close-icon">√ó</span>
          Cerrar
        </button>
      </div>
    </div>
  </div>
  </div>

  <!-- ============ MODAL DE FELICITACI√ìN (NUEVO ESTILO) ============ -->
  <div *ngIf="faseJuego === 'completado'" class="felicitacion-overlay">
    <div class="felicitacion-modal">
      <div class="felicitacion-content">
        <h2 class="felicitacion-title">¬°Felicitaciones!</h2>
        <p class="felicitacion-message">
          Has completado los <strong>{{ maxNiveles }} niveles</strong> correctamente.
        </p>
        <p class="felicitacion-submessage">
          Excelente trabajo ordenando las secuencias terap√©uticas.
        </p>
        
        <div class="felicitacion-stats-mini">
          <div class="stat-mini">
            <span class="stat-mini-icon"></span>
            <span class="stat-mini-value">{{ maxNiveles }}/{{ maxNiveles }}</span>
            <span class="stat-mini-label">Niveles</span>
          </div>
          <div class="stat-mini">
            <span class="stat-mini-icon"></span>
            <span class="stat-mini-value">{{ secuenciasCorrectas }}</span>
            <span class="stat-mini-label">Secuencias</span>
          </div>
        </div>
        
        <div class="felicitacion-actions">
          <button class="btn-continuar" (click)="reiniciarJuego()">
            <span class="btn-icon">üîÑ</span>
            Jugar de Nuevo
          </button>
          <button class="btn-terminar" (click)="volverAJuegos()">
            <span class="btn-icon">üè†</span>
            Volver al Men√∫
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ MODAL PERSONALIZADO (para mensajes durante el juego) ============ -->
  <div *ngIf="mostrarModal" class="modal-overlay" (click)="cerrarModal()">
    <div class="modal-content" [ngClass]="'modal-' + tipoModal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ tituloModal }}</h3>
        <button class="btn-close-modal" (click)="cerrarModal()">√ó</button>
      </div>
      
      <div class="modal-body">
        <p>{{ mensajeModal }}</p>
        <div *ngIf="puntosModal > 0" class="puntos-ganados">
          <span class="puntos-icon">üéØ</span>
          <span class="puntos-valor">+{{ puntosModal }}</span>
          <span class="puntos-texto">puntos</span>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn-modal-ok" (click)="cerrarModal()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div *ngIf="faseJuego === 'verificando'" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>Verificando secuencia...</p>
    </div>
  </div>
</div>