<!-- puzzle-movimientos-game.component.html -->

<div class="game-container">
  <!-- Header del juego -->
  <header class="game-header">
    <div class="header-content">
      <button class="btn-back" (click)="volverAJuegos()">
        <span class="back-icon">←</span>
        <span>Volver</span>
      </button>
      
      <div class="game-info">
        <h1>🧩 Puzzle de Movimientos</h1>
        <p>Ordena los ejercicios en la secuencia correcta</p>
      </div>
      
      <div class="game-stats" *ngIf="faseJuego !== 'instrucciones' && faseJuego !== 'captura'">
        <div class="stat-item">
          <span class="stat-icon">📈</span>
          <span class="stat-value">{{ nivelActual }}/{{ maxNiveles }}</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Pantalla de instrucciones -->
  <div *ngIf="faseJuego === 'instrucciones'" class="instructions-screen">
    <div class="instructions-content">
      <div class="instructions-header">
        <h2>🧩 ¿Cómo jugar?</h2>
        <div class="game-icon">🎯</div>
      </div>
      
      <div class="instructions-list">
        <div class="instruction-item">
          <span class="instruction-number">1</span>
          <div class="instruction-text">
            <h3>📸 Tómate fotos haciendo los movimientos</h3>
            <p>Primero capturaremos tus fotos haciendo cada ejercicio lingual</p>
          </div>
        </div>
        
        <div class="instruction-item">
          <span class="instruction-number">2</span>
          <div class="instruction-text">
            <h3>🎯 El sistema validará tu movimiento</h3>
            <p>Solo podrás capturar la foto cuando hagas el ejercicio correctamente</p>
          </div>
        </div>
        
        <div class="instruction-item">
          <span class="instruction-number">3</span>
          <div class="instruction-text">
            <h3>🧩 Arrastra tus fotos</h3>
            <p>Ordena tus propias fotos en la secuencia correcta</p>
          </div>
        </div>
        
        <div class="instruction-item">
          <span class="instruction-number">4</span>
          <div class="instruction-text">
            <h3>✅ Verifica tu secuencia</h3>
            <p>Presiona el botón para comprobar si el orden es correcto</p>
          </div>
        </div>
      </div>
      
      <div class="instructions-footer">
        <button class="btn-primary" (click)="empezarNivel()">
          📸 ¡Tomar Fotos y Jugar! 🚀
        </button>
        <p class="difficulty-info">6 niveles de dificultad progresiva</p>
      </div>
    </div>
  </div>

  <!-- ============ FASE DE CAPTURA DE FOTOS ============ -->
  <div *ngIf="faseJuego === 'captura'" class="capture-screen">
    <div class="capture-content">
      <div class="capture-header">
        <h2>📸 Captura de Movimientos</h2>
        <p>Tómate fotos haciendo cada ejercicio lingual</p>
      </div>

      <!-- Movimiento actual -->
      <div class="current-movement">
        <div class="movement-info">
          <div class="movement-icon">
            {{ todosLosMovimientos[movimientoActualCaptura].emoji }}
          </div>
          <h3>{{ todosLosMovimientos[movimientoActualCaptura].nombre }}</h3>
          <p class="movement-instruction">
            {{ todosLosMovimientos[movimientoActualCaptura].instruccion }}
          </p>
        </div>
      </div>

      <!-- Cámara y Canvas -->
      <div class="camera-container">
        <div class="video-wrapper">
          <video #videoElement autoplay playsinline class="camera-video"></video>
          <canvas #canvasElement class="camera-canvas"></canvas>
          
          <!-- Overlay de validación -->
          <div class="validation-overlay" 
               [class.detected]="movimientoDetectado"
               [class.not-detected]="!movimientoDetectado">
            <div class="validation-message">
              <p>{{ mensajeValidacion }}</p>
            </div>
          </div>
        </div>

        <!-- Botón de captura -->
        <div class="capture-actions">
          <button 
            class="btn-capture"
            [disabled]="!movimientoDetectado"
            [class.ready]="movimientoDetectado"
            (click)="capturarFoto()">
            <span class="capture-icon">📸</span>
            <span *ngIf="movimientoDetectado">¡Tomar Foto!</span>
            <span *ngIf="!movimientoDetectado">Haz el movimiento primero</span>
          </button>
        </div>
      </div>

      <!-- Progreso de captura -->
      <div class="capture-progress">
        <h4>Progreso de fotos:</h4>
        <div class="photos-progress">
          <div *ngFor="let mov of todosLosMovimientos; let i = index" 
               class="photo-item"
               [class.completed]="mov.foto !== null"
               [class.current]="i === movimientoActualCaptura">
            <div class="photo-icon">
              <span *ngIf="mov.foto === null">{{ mov.emoji }}</span>
              <span *ngIf="mov.foto !== null">✅</span>
            </div>
            <span class="photo-name">{{ mov.nombre }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ PANTALLA DE JUEGO ============ -->
  <div *ngIf="estaJugando" class="game-screen">
    <!-- Información del nivel -->
    <div class="level-info">
      <div class="level-header">
        <h2>Nivel {{ nivelActual }}: {{ secuenciaActual?.nombre }}</h2>
        <p>{{ secuenciaActual?.descripcion }}</p>
        <div class="difficulty-badge" [ngClass]="'difficulty-' + secuenciaActual?.dificultad">
          {{ secuenciaActual?.dificultad?.toUpperCase() }}
        </div>
      </div>
      
      <div class="game-controls">
        <div class="timer-display">
          <span class="timer-icon">⏱️</span>
          <span class="timer-text">{{ formatearTiempo(obtenerTiempoRestante()) }}</span>
        </div>
        
        <div class="attempts-display">
          <span class="attempts-icon">🎯</span>
          <span class="attempts-text">Intento {{ intentos + 1 }}</span>
        </div>
        
        <div class="progress-display">
          <span class="progress-icon">📊</span>
          <span class="progress-text">{{ obtenerPorcentajeProgreso() }}%</span>
        </div>
      </div>
    </div>

    <!-- LAYOUT DE 2 COLUMNAS -->
    <div class="game-layout-columns">
      <!-- COLUMNA IZQUIERDA: Banco de fotos -->
      <div class="movements-bank movements-bank-vertical">
        <!-- Indicador de cantidad de fotos -->
        <div class="photos-counter">
          📸 {{ movimientosArrastrable.length }} fotos disponibles
        </div>
        
        <div class="movements-vertical-list">
        <div 
          *ngFor="let movimiento of movimientosArrastrable" 
          class="movement-card movement-card-compact"
          [ngClass]="{
            'movement-placed': movimiento.colocado,
            'movement-dragging': movimiento.arrastrando,
            'movement-available': !movimiento.colocado
          }"
          [draggable]="!movimiento.colocado && faseJuego === 'jugando'"
          (dragstart)="onDragStart($event, movimiento)"
          (dragend)="onDragEnd($event, movimiento)">
          
          <!-- Mostrar foto si existe -->
          <div class="movement-photo movement-photo-compact" *ngIf="movimiento.foto">
            <img [src]="movimiento.foto" alt="Foto del movimiento">
          </div>
          
          <!-- Mostrar emoji si no hay foto (fallback) -->
          <div class="movement-emoji movement-emoji-compact" *ngIf="!movimiento.foto">
            {{ movimiento.emoji }}
          </div>
          
          <div class="movement-name movement-name-compact">{{ movimiento.nombre }}</div>
          
          <!-- Indicador si ya fue colocado -->
          <div *ngIf="movimiento.colocado" class="placed-indicator placed-indicator-compact">
            <span class="placed-icon">✓</span>
          </div>
        </div>
        </div>
      </div>
      <!-- FIN COLUMNA IZQUIERDA -->

      <!-- COLUMNA DERECHA: Zona de construcción -->
      <div class="sequence-column">
        <!-- Zona de construcción de secuencia - ABAJO -->
        <div class="sequence-builder">
          <h3>🎯 Construye la secuencia correcta:</h3>
      
      <div class="drop-zones" [style.grid-template-columns]="'repeat(' + zonasDestino.length + ', 1fr)'">
        <div 
          *ngFor="let zona of zonasDestino; let i = index" 
          class="drop-zone"
          [ngClass]="{
            'zone-occupied': zona !== null,
            'zone-correct': secuenciaCompleta && obtenerMovimientoPorId(zona!)?.posicionCorrecta === i,
            'zone-incorrect': faseJuego === 'verificando' && zona !== null && obtenerMovimientoPorId(zona!)?.posicionCorrecta !== i
          }"
          (dragover)="onDragOver($event)"
          (drop)="onDrop($event, i)">
          
          <div class="zone-number">{{ i + 1 }}</div>
          
          <div *ngIf="zona === null" class="zone-placeholder">
            <span class="placeholder-icon">📋</span>
            <span class="placeholder-text">Suelta aquí</span>
          </div>
          
          <div *ngIf="zona !== null" class="zone-content">
            <div class="movement-card placed" 
                 [draggable]="faseJuego === 'jugando'"
                 (dragstart)="onDragStart($event, obtenerMovimientoPorId(zona)!)">
              
              <!-- Mostrar foto si existe -->
              <div class="movement-photo" *ngIf="obtenerMovimientoPorId(zona)?.foto">
                <img [src]="obtenerMovimientoPorId(zona)?.foto" alt="Foto del movimiento">
              </div>
              
              <!-- Mostrar emoji si no hay foto (fallback) -->
              <div class="movement-emoji" *ngIf="!obtenerMovimientoPorId(zona)?.foto">
                {{ obtenerMovimientoPorId(zona)?.emoji }}
              </div>
              
              <div class="movement-name">{{ obtenerMovimientoPorId(zona)?.nombre }}</div>
              <div class="movement-instruction">{{ obtenerMovimientoPorId(zona)?.instruccion }}</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sequence-actions">
        <button 
          class="btn-verify" 
          [disabled]="faseJuego === 'verificando' || !secuenciaCompleta"
          (click)="verificarSecuencia()">
          <span class="verify-icon">✓</span>
          Verificar Secuencia
        </button>
        
        <button 
          *ngIf="mostrarPista" 
          class="btn-hint"
          (click)="mostrarPista = false">
          <span class="hint-icon">💡</span>
          Ocultar Pista
        </button>
      </div>
    </div>
    </div>
    <!-- FIN LAYOUT DE 2 COLUMNAS -->

    <!-- Panel de pistas -->
    <div *ngIf="mostrarPista" class="hints-panel">
      <div class="hints-content">
        <h4>💡 Pista para la secuencia:</h4>
        <div class="hint-text">
          <p>Los ejercicios linguales suelen seguir este orden:</p>
          <ol class="hint-list">
            <li>Preparación y posicionamiento inicial</li>
            <li>Movimientos básicos de extensión</li>
            <li>Ejercicios de coordinación lateral</li>
            <li>Movimientos avanzados y precisos</li>
            <li>Relajación y posición de descanso</li>
          </ol>
        </div>
        
        <button class="btn-close-hint" (click)="mostrarPista = false">
          <span class="close-icon">×</span>
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- ============ PANTALLA DE COMPLETADO ============ -->
  <div *ngIf="estaCompletado" class="completion-screen">
    <div class="completion-content">
      <div class="completion-header">
        <h2>🎉 ¡Felicitaciones!</h2>
        <div class="completion-icon">
          <span>🏆</span>
        </div>
      </div>
      
      <div class="completion-stats">
        <div class="completion-details">
          <div class="stat-final">
            <span class="stat-icon">📊</span>
            <span class="stat-text">Niveles completados: {{ nivelActual }}/{{ maxNiveles }}</span>
          </div>
          
          <div class="stat-final">
            <span class="stat-icon">✅</span>
            <span class="stat-text">Secuencias correctas: {{ secuenciasCorrectas }}</span>
          </div>
        </div>
      </div>
      
      <div class="completion-message">
        <p>¡Excelente trabajo ordenando las secuencias de ejercicios linguales!</p>
        <p>Has demostrado gran capacidad de secuenciación lógica y comprensión de los movimientos terapéuticos.</p>
      </div>
      
      <div class="completion-actions">
        <button class="btn-restart" (click)="reiniciarJuego()">
          <span class="restart-icon">🔄</span>
          Jugar de Nuevo
        </button>
        
        <button class="btn-continue" (click)="siguienteJuego()">
          <span class="continue-icon">➡️</span>
          Siguiente Juego
        </button>
        
        <button class="btn-menu" (click)="volverAJuegos()">
          <span class="menu-icon">🏠</span>
          Menú de Juegos
        </button>
      </div>
    </div>
  </div>

  <!-- ============ MODAL PERSONALIZADO ============ -->
  <div *ngIf="mostrarModal" class="modal-overlay" (click)="cerrarModal()">
    <div class="modal-content" [ngClass]="'modal-' + tipoModal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ tituloModal }}</h3>
        <button class="btn-close-modal" (click)="cerrarModal()">×</button>
      </div>
      
      <div class="modal-body">
        <p>{{ mensajeModal }}</p>
        <div *ngIf="puntosModal > 0" class="puntos-ganados">
          <span class="puntos-icon">🎯</span>
          <span class="puntos-valor">+{{ puntosModal }}</span>
          <span class="puntos-texto">puntos</span>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn-modal-ok" (click)="cerrarModal()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div *ngIf="faseJuego === 'verificando'" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>Verificando secuencia...</p>
    </div>
  </div>
</div>