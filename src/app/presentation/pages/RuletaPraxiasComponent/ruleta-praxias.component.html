<div class="ruleta-container">
  
  <!-- ğŸ¯ FASE 1: HEADER DE PROGRESO DIARIO -->
  <div class="progress-header">
    <button class="btn-back" (click)="goBackToGames()" title="Volver a Juegos TerapÃ©uticos">
      â† Volver
    </button>
    
    <div class="daily-progress-card">
      <div class="progress-info">
        <span class="progress-icon">ğŸ¯</span>
        <div class="progress-text">
          <span class="progress-label">Progreso de Hoy</span>
          <span class="progress-numbers">{{totalExercisesToday}} / {{maxExercisesPerDay}} ejercicios</span>
        </div>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar-fill" [style.width.%]="getDailyProgressPercentage()"></div>
      </div>
      <span class="progress-percentage">{{getDailyProgressPercentage()}}%</span>
    </div>
  </div>

  <!-- TÃTULO PRINCIPAL -->
  <div class="main-header">
    <h1 class="main-title">
      <span class="title-icon"></span>
      Ruleta de Praxias
      <span class="title-icon"></span>
    </h1>
    <p class="main-subtitle">Â¡Gira la ruleta y practica tus ejercicios orofaciales!</p>
  </div>
  
  <div class="game-wrapper">
    
    <div class="wheel-section">
      
      <!-- NUEVA RULETA MEJORADA -->
      <div class="wheel-wrapper">
        <svg width="400" height="400" viewBox="0 0 400 400" class="ruleta-svg"
          [style.transform]="'rotate(' + rotation + 'deg)'"
          [class.spinning]="isSpinning">
          
          <!-- DEFINIR GRADIENTES CON COLORES SUAVES Y PASTELES -->
          <defs>
            <!-- Gradiente Beso - Rosa suave -->
            <linearGradient id="gradBeso" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#FFB6C1;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#FF92A5;stop-opacity:1" />
            </linearGradient>
            
            <!-- Gradiente Cachetes - Azul cielo claro -->
            <linearGradient id="gradCachetes" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#87CEEB;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#6FB7E8;stop-opacity:1" />
            </linearGradient>
            
            <!-- Gradiente Lengua - Turquesa suave -->
            <linearGradient id="gradLengua" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#7FDBFF;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#5BC0DE;stop-opacity:1" />
            </linearGradient>
            
            <!-- Gradiente Sonrisa - Durazno suave -->
            <linearGradient id="gradSonrisa" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#FFDAB9;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#FFB88C;stop-opacity:1" />
            </linearGradient>
            
            <!-- Gradiente Soplar - Azul claro pastel -->
            <linearGradient id="gradSoplar" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#B0E0E6;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#ADD8E6;stop-opacity:1" />
            </linearGradient>
          </defs>
          
          <!-- SECCIONES PERFECTAS CON TRIGONOMETRÃA EXACTA (5 x 72Â° = 360Â°) -->
          
          <!-- SECCIÃ“N 1 - BESO: 0Â° a 72Â° -->
          <path d="M 200 200 L 360 200 A 160 160 0 0 1 249.44 352.17 Z" 
                fill="url(#gradBeso)" 
                stroke="#ffffff" 
                stroke-width="2"/>
          <circle cx="284" cy="261" r="35" fill="white" opacity="0.95"/>
          <image href="assets/images/BesoPez.png" x="259" y="236" width="50" height="50"/>
          
          <!-- SECCIÃ“N 2 - CACHETES: 72Â° a 144Â° -->
          <path d="M 200 200 L 249.44 352.17 A 160 160 0 0 1 70.56 294.05 Z" 
                fill="url(#gradCachetes)" 
                stroke="#ffffff" 
                stroke-width="2"/>
          <circle cx="168" cy="299" r="35" fill="white" opacity="0.95"/>
          <image href="assets/images/MejillaDeGlobo.png" x="143" y="274" width="50" height="50"/>
          
          <!-- SECCIÃ“N 3 - LENGUA: 144Â° a 216Â° -->
          <path d="M 200 200 L 70.56 294.05 A 160 160 0 0 1 70.56 105.95 Z" 
                fill="url(#gradLengua)" 
                stroke="#ffffff" 
                stroke-width="2"/>
          <circle cx="96" cy="200" r="35" fill="white" opacity="0.95"/>
          <image href="assets/images/LenguaLateral.png" x="71" y="175" width="50" height="50"/>
          
          <!-- SECCIÃ“N 4 - SONRISA: 216Â° a 288Â° -->
          <path d="M 200 200 L 70.56 105.95 A 160 160 0 0 1 249.44 47.83 Z" 
                fill="url(#gradSonrisa)" 
                stroke="#ffffff" 
                stroke-width="2"/>
          <circle cx="168" cy="101" r="35" fill="white" opacity="0.95"/>
          <image href="assets/images/SonrisaGrande.png" x="143" y="76" width="50" height="50"/>
          
          <!-- SECCIÃ“N 5 - SOPLAR: 288Â° a 360Â° (0Â°) -->
          <path d="M 200 200 L 249.44 47.83 A 160 160 0 0 1 360 200 Z" 
                fill="url(#gradSoplar)" 
                stroke="#ffffff" 
                stroke-width="2"/>
          <circle cx="284" cy="139" r="35" fill="white" opacity="0.95"/>
          <image href="assets/images/Soplar.png" x="259" y="114" width="50" height="50"/>
          
          <!-- CÃRCULO CENTRO -->
          <circle cx="200" cy="200" r="65" fill="#333333" opacity="0.15"/>
          <circle cx="200" cy="200" r="60" fill="#FFEB3B" stroke="#333333" stroke-width="4"/>
          <text x="200" y="210" text-anchor="middle" font-size="22" font-weight="bold" fill="#333">Â¡GIRA!</text>
          
          <!-- BORDE EXTERIOR -->
          <circle cx="200" cy="200" r="160" fill="none" stroke="#E0E0E0" stroke-width="4"/>
          <circle cx="200" cy="200" r="164" fill="none" stroke="#CCCCCC" stroke-width="2" opacity="0.5"/>
        </svg>
        
        <!-- FLECHA INDICADORA (apuntando hacia la ruleta desde la derecha) -->
        <div class="arrow-pointer"></div>
      </div>
      
      <div class="button-row">
        <button class="btn-spin" [disabled]="isSpinning" (click)="spinWheel()">
          ğŸ² {{isSpinning ? 'Â¡GIRANDO!' : 'Â¡GIRAR AHORA!'}}
        </button>
        <button class="btn-reset" (click)="resetRuleta()">
          ğŸ”„ REINICIAR
        </button>
      </div>
    </div>

    <div class="side-panel">
      
      <!-- Pantalla de instrucciones -->
      <div *ngIf="showInstructions && selectedPraxia && !isCameraActive && !isExerciseCorrect" class="praxia-display">
        <img [src]="'assets/images/' + selectedPraxia.imageName" alt="{{selectedPraxia.nombre}}" class="big-image">
        <h2 class="praxia-title">{{selectedPraxia?.nombre}}</h2>
        
        <!-- ğŸ¯ FASE 1: PROGRESO DE REPETICIONES DEL EJERCICIO -->
        <div class="exercise-progress-badge" 
             [class.complete]="isCurrentExerciseComplete()">
          <span class="badge-icon">{{isCurrentExerciseComplete() ? 'âœ…' : 'ğŸ”„'}}</span>
          <span class="badge-text">
            {{isCurrentExerciseComplete() ? 'Â¡Completado!' : getCurrentExerciseProgress() + ' completadas'}}
          </span>
        </div>
      </div>

      <div *ngIf="showInstructions && selectedPraxia && !isCameraActive && !isExerciseCorrect" class="instruction-panel">
        <div class="instruction-header">
          <span class="icon">ğŸ“‹</span>
          <h3>Â¿CÃ³mo hacerlo?</h3>
        </div>
        <p class="instruction-text">{{selectedPraxia?.instruccion}}</p>
        
        <div class="info-cards">
          <div class="info-card">
            <div class="info-icon">â±ï¸</div>
            <div class="info-content">
              <span class="info-label">DURACIÃ“N</span>
              <span class="info-value">{{selectedPraxia?.duracion}}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-icon">ğŸ”„</div>
            <div class="info-content">
              <span class="info-label">REPETICIONES</span>
              <span class="info-value">{{selectedPraxia?.repeticiones}}x</span>
            </div>
          </div>
        </div>
        
        <button class="btn-start" 
                (click)="startCamera()">
          ğŸ“¹ Â¡COMENZAR DESAFÃO!
        </button>
      </div>

      <!-- Panel de cÃ¡mara activa -->
      <div *ngIf="isCameraActive && !isExerciseCorrect" class="camera-panel">
        <div class="camera-header">
          <h3>{{selectedPraxia?.nombre}}</h3>
          <button class="btn-close" (click)="stopCamera()">âœ•</button>
        </div>
        
        <!-- ğŸ¯ FASE 1: MINI CONTADOR EN CÃMARA -->
        <div class="camera-exercise-counter">
          <span class="counter-icon">ğŸ”„</span>
          <span class="counter-text">{{getCurrentExerciseProgress()}}</span>
        </div>
        
        <!-- VIDEO LIMPIO SIN OVERLAYS -->
        <div class="video-wrapper">
          <video #videoElement autoplay muted playsinline class="video-feed"></video>
          <canvas #canvasElement class="canvas-overlay"></canvas>
        </div>

        <!-- PANEL DE CONTROLES EXTERNOS -->
        <div class="controls-panel">
          
          <!-- Progreso Circular -->
          <div class="control-item progress-item">
            <div class="progress-ring">
              <svg width="100" height="100">
                <circle cx="50" cy="50" r="40" stroke="#e0e0e0" stroke-width="8" fill="none"></circle>
                <circle cx="50" cy="50" r="40" stroke="#4CAF50" stroke-width="8" fill="none"
                  [style.stroke-dasharray]="2 * Math.PI * 40"
                  [style.stroke-dashoffset]="2 * Math.PI * 40 * (1 - exerciseProgress / 100)"
                  class="progress-fill"></circle>
              </svg>
              <div class="progress-percent">{{exerciseProgress.toFixed(0)}}%</div>
            </div>
            <p class="control-label">Progreso</p>
          </div>

          <!-- PrecisiÃ³n -->
          <div class="control-item precision-item">
            <div class="precision-circle" [class.active]="detectionScore > 50">
              <div class="precision-icon">ğŸ¯</div>
              <div class="precision-value">{{detectionScore.toFixed(0)}}%</div>
            </div>
            <p class="control-label">PrecisiÃ³n</p>
          </div>

          <!-- BotÃ³n Toggle Marcas -->
          <div class="control-item toggle-item">
            <button class="btn-toggle-landmarks" 
                    [class.active]="showFacialLandmarks"
                    (click)="toggleFacialLandmarks()"
                    title="Mostrar/Ocultar marcas faciales">
              <span class="icon">{{showFacialLandmarks ? 'ğŸ‘ï¸' : 'ğŸ™ˆ'}}</span>
              <span class="text">{{showFacialLandmarks ? 'OCULTAR' : 'MOSTRAR'}}</span>
            </button>
            <p class="control-label">Marcas Faciales</p>
          </div>

        </div>
        
        <div class="camera-status">
          <p *ngIf="!stream">ğŸ”´ Activando cÃ¡mara...</p>
          <p *ngIf="stream && !isDetecting">ğŸ“¹ CÃ¡mara lista</p>
          <p *ngIf="isDetecting">ğŸ¤– IA detectando...</p>
        </div>
        
        <div class="feedback-box">
          <div *ngIf="detectionScore > 70" class="feedback success">Â¡PERFECTO!</div>
          <div *ngIf="detectionScore > 45 && detectionScore <= 70" class="feedback good">Â¡Muy bien!</div>
          <div *ngIf="detectionScore > 25 && detectionScore <= 45" class="feedback try">Â¡Sigue asÃ­!</div>
          <div *ngIf="detectionScore > 0 && detectionScore <= 25" class="feedback try">Â¡IntÃ©ntalo!</div>
        </div>
      </div>

      <!-- Pantalla de Ã©xito -->
      <div *ngIf="isExerciseCorrect" class="success-box">
        <div class="success-emoji-container">
          <div class="success-emoji">ğŸ‰</div>
          <div class="success-stars">
            <span class="star">â­</span>
            <span class="star">â­</span>
            <span class="star">â­</span>
          </div>
        </div>
        
        <h2 class="success-title">Â¡INCREÃBLE!</h2>
        <p class="success-message">Â¡Completaste el ejercicio perfectamente!</p>
        
        <div class="motivation-box">
          <div class="motivation-icon">ğŸ’ª</div>
          <div class="motivation-text">
            <p class="motivation-main">{{currentMotivation.main}}</p>
            <p class="motivation-sub">{{currentMotivation.sub}}</p>
          </div>
        </div>
        
        <!-- ğŸ¯ FASE 1: MOSTRAR PROGRESO ACTUALIZADO -->
        <div class="success-progress">
          <span class="success-progress-icon">ğŸ“Š</span>
          <span class="success-progress-text">
            Progreso: {{totalExercisesToday}}/{{maxExercisesPerDay}} ejercicios hoy
          </span>
        </div>
      </div>

      <!-- Pantalla de espera inicial -->
      <div *ngIf="!showInstructions && !isCameraActive && !isExerciseCorrect" class="waiting-box">
        <div class="waiting-dice">ğŸ²</div>
        <h3>Â¡Hora de Jugar!</h3>
        <p>Presiona <strong>"Â¡GIRAR AHORA!"</strong> para comenzar</p>
        <div class="tip">
          <span>ğŸ’¡</span>
          <span>La IA detectarÃ¡ tus movimientos</span>
        </div>
      </div>
      
    </div>
  </div>

  <!-- Confeti de celebraciÃ³n -->
  <div *ngIf="isExerciseCorrect" class="confetti">
    <div *ngFor="let item of [0,1,2,3,4,5,6,7,8,9]" 
         class="confetti-piece"
         [style.left.%]="getConfettiLeft(item)"
         [style.animation-delay.s]="getConfettiDelay(item)"></div>
  </div>
</div>