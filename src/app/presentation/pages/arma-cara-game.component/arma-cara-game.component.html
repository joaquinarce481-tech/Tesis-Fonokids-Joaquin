<div class="game-container">

  <!-- ========== PANTALLA DE INSTRUCCIONES ========== -->
  <div *ngIf="pantalla === 'inicio'" class="instructions-screen">
    
    <!-- Header del juego -->
    <div class="game-header">
      <div class="header-content">
        <button class="btn-back" (click)="volverADashboard()">
          <span class="back-icon">←</span>
          <span class="btn-text">Volver</span>
        </button>
        <div class="game-info">
          <h1>Arma la Cara</h1>
          <p>Reconocimiento de Emociones</p>
        </div>
        <div class="game-stats"></div>
      </div>
    </div>

    <!-- Card de instrucciones -->
    <div class="instructions-card">
      <div class="instructions-header">
        <h2>Arma la Cara</h2>
        <span class="difficulty-badge">Fácil</span>
      </div>

      <div class="instructions-content">
        <div class="step">
          <div class="step-number">1</div>
          <div class="step-text">
            <strong>Observa la emoción</strong>
            <p>El sistema elegirá una emoción al azar para que construyas</p>
          </div>
        </div>

        <div class="step">
          <div class="step-number">2</div>
          <div class="step-text">
            <strong>Selecciona las partes</strong>
            <p>Verás diferentes cejas, ojos y bocas disponibles para elegir</p>
          </div>
        </div>

        <div class="step">
          <div class="step-number">3</div>
          <div class="step-text">
            <strong>Arrastra a la cara</strong>
            <p>Arrastra cada parte facial correcta hacia su zona en la cara</p>
          </div>
        </div>

        <div class="step">
          <div class="step-number">4</div>
          <div class="step-text">
            <strong>Verifica tu respuesta</strong>
            <p>Cuando completes las 3 partes, verifica si armaste la emoción correcta</p>
          </div>
        </div>
      </div>

      <div class="tips-section">
        <h3>Consejos:</h3>
        <ul>
          <li>Observa bien el nombre de la emoción antes de empezar</li>
          <li>Piensa cómo se ve cada emoción en una cara real</li>
          <li>Si te equivocas, puedes volver a intentarlo</li>
          <li>Practica con todas las emociones disponibles</li>
        </ul>
      </div>

      <button class="btn-start" (click)="irASeleccion()">
        Comenzar a Jugar
      </button>
    </div>

    <!-- Estadísticas -->
    <div class="stats-card" *ngIf="totalJugados > 0">
      <div class="stat-item">
        <span class="stat-valor">{{ totalJugados }}</span>
        <span class="stat-label">Emociones completadas</span>
      </div>
    </div>
  </div>

  <!-- ========== PANTALLA DE JUEGO ========== -->
  <div *ngIf="pantalla === 'juego' && emocionActual" class="pantalla-juego">
    
    <!-- Header del juego -->
    <div class="game-header">
      <div class="header-content">
        <button class="btn-back" (click)="volverAlInicio()">
          <span class="back-icon">←</span>
          <span class="btn-text">Volver</span>
        </button>
        <div class="game-info">
          <h1>Arma la Cara</h1>
          <p>Reconocimiento de Emociones</p>
        </div>
        <div class="game-stats"></div>
      </div>
    </div>

    <!-- Tarjeta de objetivo -->
    <div class="objetivo-card">
      <span class="objetivo-label">Tu desafío:</span>
      <span class="objetivo-emocion" [style.color]="emociones[emocionActual!].color">
        Arma la cara {{ emociones[emocionActual!].nombre }}
      </span>
    </div>

    <!-- Área del juego -->
    <div class="juego-contenido">
      
      <!-- Columna de la Cara -->
      <div class="cara-panel">
        <h3 class="panel-titulo">Zona de Construcción</h3>
        
        <div class="cara-container">
          <svg class="face-svg" viewBox="0 0 300 400" preserveAspectRatio="xMidYMid meet">
            <defs>
              <linearGradient id="faceGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#fef3c7;stop-opacity:1"/>
                <stop offset="100%" style="stop-color:#fde68a;stop-opacity:1"/>
              </linearGradient>
              <filter id="faceShadow" x="-20%" y="-20%" width="140%" height="140%">
                <feDropShadow dx="0" dy="4" stdDeviation="8" flood-color="#000" flood-opacity="0.15"/>
              </filter>
            </defs>
            <ellipse cx="150" cy="200" rx="135" ry="180" 
                     fill="url(#faceGrad)" 
                     stroke="#d97706" 
                     stroke-width="4"
                     filter="url(#faceShadow)"/>
          </svg>

          <!-- Elementos fijos de la cara -->
          <div class="elementos-fijos">
            <div class="ojos-base">
              <span class="ojo-base">●</span>
              <span class="ojo-base">●</span>
            </div>
            <div class="nariz-base">▽</div>
          </div>

          <!-- Zona de Cejas -->
          <div 
            class="drop-zone"
            [class.drop-zone-filled]="partesColocadas.cejas"
            [style.--accent-color]="emociones[emocionActual!].color"
            style="top: 28%; left: 50%;"
            (dragover)="handleDragOver($event)"
            (drop)="handleDrop('cejas')">
            
            <img *ngIf="partesColocadas.cejas" 
                 [src]="partesColocadas.cejas.imagen" 
                 [alt]="partesColocadas.cejas.nombre"
                 class="parte-colocada-img">
            
            <span *ngIf="!partesColocadas.cejas" class="drop-zone-label">Cejas</span>
          </div>

          <!-- Zona de Ojos -->
          <div 
            class="drop-zone"
            [class.drop-zone-filled]="partesColocadas.ojos"
            [style.--accent-color]="emociones[emocionActual!].color"
            style="top: 43%; left: 50%;"
            (dragover)="handleDragOver($event)"
            (drop)="handleDrop('ojos')">
            
            <img *ngIf="partesColocadas.ojos" 
                 [src]="partesColocadas.ojos.imagen" 
                 [alt]="partesColocadas.ojos.nombre"
                 class="parte-colocada-img">
            
            <span *ngIf="!partesColocadas.ojos" class="drop-zone-label">Ojos</span>
          </div>

          <!-- Zona de Boca -->
          <div 
            class="drop-zone"
            [class.drop-zone-filled]="partesColocadas.boca"
            [style.--accent-color]="emociones[emocionActual!].color"
            style="top: 72%; left: 50%;"
            (dragover)="handleDragOver($event)"
            (drop)="handleDrop('boca')">
            
            <img *ngIf="partesColocadas.boca" 
                 [src]="partesColocadas.boca.imagen" 
                 [alt]="partesColocadas.boca.nombre"
                 class="parte-colocada-img">
            
            <span *ngIf="!partesColocadas.boca" class="drop-zone-label">Boca</span>
          </div>
        </div>

        <!-- Barra de progreso -->
        <div class="progreso-section">
          <div class="progreso-bar">
            <div 
              class="progreso-fill" 
              [style.width.%]="(getPartesColocadasCount() / 3) * 100"
              [style.background]="emociones[emocionActual!].color">
            </div>
          </div>
          <span class="progreso-text">{{ getPartesColocadasCount() }} / 3 partes</span>
        </div>

        <!-- Botón Verificar -->
        <button 
          *ngIf="juegoCompletado()"
          class="btn-verificar"
          [style.background]="emociones[emocionActual!].color"
          (click)="verificarRespuesta()">
          Verificar Respuesta
        </button>
      </div>

      <!-- Columna de Partes -->
      <div class="partes-panel">
        <h3 class="panel-titulo">Partes Disponibles</h3>
        
        <!-- Sección Cejas -->
        <div class="partes-seccion">
          <h4 class="seccion-label">Cejas</h4>
          <div class="partes-grid">
            <div
              *ngFor="let parte of partesDisponibles.cejas"
              class="parte-item"
              [class.parte-usada]="partesColocadas.cejas?.id === parte.id"
              [attr.draggable]="partesColocadas.cejas?.id !== parte.id"
              (dragstart)="handleDragStart('cejas', parte)">
              
              <div class="parte-img-wrapper">
                <img [src]="parte.imagen" [alt]="parte.nombre" class="parte-img">
              </div>
              <span class="parte-nombre">{{ parte.nombre }}</span>
              <span class="parte-estado" *ngIf="partesColocadas.cejas?.id === parte.id">Colocada</span>
            </div>
          </div>
        </div>

        <!-- Sección Ojos -->
        <div class="partes-seccion">
          <h4 class="seccion-label">Ojos</h4>
          <div class="partes-grid">
            <div
              *ngFor="let parte of partesDisponibles.ojos"
              class="parte-item"
              [class.parte-usada]="partesColocadas.ojos?.id === parte.id"
              [attr.draggable]="partesColocadas.ojos?.id !== parte.id"
              (dragstart)="handleDragStart('ojos', parte)">
              
              <div class="parte-img-wrapper">
                <img [src]="parte.imagen" [alt]="parte.nombre" class="parte-img">
              </div>
              <span class="parte-nombre">{{ parte.nombre }}</span>
              <span class="parte-estado" *ngIf="partesColocadas.ojos?.id === parte.id">Colocada</span>
            </div>
          </div>
        </div>

        <!-- Sección Boca -->
        <div class="partes-seccion">
          <h4 class="seccion-label">Boca</h4>
          <div class="partes-grid">
            <div
              *ngFor="let parte of partesDisponibles.boca"
              class="parte-item"
              [class.parte-usada]="partesColocadas.boca?.id === parte.id"
              [attr.draggable]="partesColocadas.boca?.id !== parte.id"
              (dragstart)="handleDragStart('boca', parte)">
              
              <div class="parte-img-wrapper">
                <img [src]="parte.imagen" [alt]="parte.nombre" class="parte-img">
              </div>
              <span class="parte-nombre">{{ parte.nombre }}</span>
              <span class="parte-estado" *ngIf="partesColocadas.boca?.id === parte.id">Colocada</span>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

  <!-- ========== PANTALLA DE COMPLETADO ========== -->
  <div *ngIf="pantalla === 'completado'" class="pantalla-completado">
    <div class="completado-card">
      
      <div class="completado-icon">
        <svg viewBox="0 0 100 100" class="star-icon">
          <path d="M50 15 L61 38 L85 42 L68 58 L72 82 L50 70 L28 82 L32 58 L15 42 L39 38 Z" 
                fill="#ffd700" stroke="#f5a623" stroke-width="2"/>
        </svg>
      </div>
      
      <h2 class="completado-titulo">¡Excelente!</h2>
      <p class="completado-mensaje">Has completado la emoción correctamente</p>

      <div class="completado-botones">
        <button class="btn-primario" (click)="volverASeleccion()">
          Nueva Emoción
        </button>
        <button class="btn-secundario" (click)="volverAlInicio()">
          Menú Principal
        </button>
        <button class="btn-terciario" (click)="volverADashboard()">
          Ir al Dashboard
        </button>
      </div>

    </div>
  </div>

  <!-- ========== MODAL DE ERROR ========== -->
  <div *ngIf="mostrarModalError" class="modal-overlay" (click)="cerrarModalError()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      
      <div class="modal-icon">
        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 8v4M12 16h.01"/>
        </svg>
      </div>
      
      <h2 class="modal-titulo">¡Casi lo tienes!</h2>
      <p class="modal-mensaje">Revisa las partes de la cara e intenta nuevamente.</p>
      
      <button class="btn-modal" (click)="cerrarModalError()">
        Intentar de Nuevo
      </button>
      
    </div>
  </div>

</div>